{% extends "base.html" %}

{% block title %}Todas las Pel√≠culas - YTS Downloader{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Todas las Pel√≠culas</h1>
    <div class="page-actions">
        <button id="checkStatusBtn" class="status-btn">
            üîÑ Actualizar Estados
        </button>
        <span id="transmissionStatus" class="transmission-status">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">Verificando conexi√≥n...</span>
        </span>
    </div>
</div>

<div class="movies-grid">
    {% for movie in movies %}
    <div class="movie-card">
        <div class="movie-info">
            <h3 class="movie-title">{{ movie.movie_title }}</h3>
            <div class="movie-details">
                {% if movie.year %}
                <span>üìÖ {{ movie.year }}</span>
                {% endif %}
                {% if movie.rating %}
                <span>‚≠ê {{ movie.rating }}/10</span>
                {% endif %}
                {% if movie.imdb_code %}
                <a href="https://www.imdb.com/title/{{ movie.imdb_code }}" target="_blank" class="imdb-link">
                    üé¨ IMDB
                </a>
                {% endif %}
            </div>
            <div class="movie-meta">
                <span class="user-info">üë§ {{ movie.user.username }}</span>
                <span class="date-info">üìÖ {{ movie.download_date.strftime('%d/%m/%Y') }}</span>
            </div>
            <div class="movie-status">
                <span class="status-badge {{ movie.status }}">{{ movie.status }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not movies %}
<div class="empty-state">
    <p class="no-results">No hay pel√≠culas agregadas a√∫n</p>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkStatusBtn = document.getElementById('checkStatusBtn');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    
    // Verificar estado de conexi√≥n al cargar
    checkTransmissionConnection();
    
    // Bot√≥n para actualizar estados
    checkStatusBtn.addEventListener('click', function() {
        checkStatusBtn.disabled = true;
        checkStatusBtn.innerHTML = 'üîÑ Actualizando...';
        
        fetch('/api/check-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(async data => {
            if (data.message) {
                await showAlert('üîÑ ¬°Actualizado!', 'Estados actualizados correctamente', 'success');
                location.reload(); // Recargar para mostrar cambios
            } else {
                await showAlert('Error', 'Error al actualizar estados: ' + (data.error || 'Error desconocido'), 'error');
            }
        })
        .catch(async error => {
            console.error('Error:', error);
            await showAlert('Error', 'Error al actualizar estados', 'error');
        })
        .finally(() => {
            checkStatusBtn.disabled = false;
            checkStatusBtn.innerHTML = 'üîÑ Actualizar Estados';
        });
    });
    
    function checkTransmissionConnection() {
        fetch('/api/transmission-status')
        .then(response => response.json())
        .then(data => {
            if (data.connected) {
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = `Transmission ${data.version || 'conectado'}`;
            } else {
                statusIndicator.className = 'status-indicator disconnected';
                statusText.textContent = 'Transmission desconectado';
            }
        })
        .catch(error => {
            statusIndicator.className = 'status-indicator error';
            statusText.textContent = 'Error de conexi√≥n';
        });
    }
});
</script>
{% endblock %}
