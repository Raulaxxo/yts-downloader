{% extends "base.html" %}

{% block title %}Editar Perfil - YTS Downloader{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
{% endblock %}

{% block content %}
<div class="edit-profile-container">
    <div class="page-header">
        <h1>‚úèÔ∏è Editar Perfil</h1>
        <a href="{{ url_for('profile') }}" class="btn btn-outline">‚Üê Volver al Perfil</a>
    </div>

    <form id="editProfileForm" class="profile-form">
        <div class="form-sections">
            <!-- Informaci√≥n Personal -->
            <div class="form-section">
                <h2 class="section-title">üë§ Informaci√≥n Personal</h2>
                
                <div class="avatar-section">
                    <div class="current-avatar">
                        {% if user.avatar_url %}
                            <img src="{{ user.avatar_url }}" alt="Avatar" class="avatar-preview" id="avatarPreview">
                        {% else %}
                            <div class="avatar-placeholder" id="avatarPlaceholder">
                                <span class="avatar-initials">{{ user.username[0].upper() }}</span>
                            </div>
                        {% endif %}
                    </div>
                    <div class="avatar-controls">
                        <div class="form-group">
                            <label for="avatar_file">Subir Nueva Imagen</label>
                            <div class="file-upload-wrapper">
                                <input type="file" id="avatar_file" name="avatar_file" 
                                       accept="image/*" class="file-input">
                                <label for="avatar_file" class="file-upload-btn">
                                    üìÅ Seleccionar Imagen
                                </label>
                                <span class="file-name" id="fileName">Ning√∫n archivo seleccionado</span>
                            </div>
                            <small class="form-help">Formatos soportados: JPG, PNG, GIF. M√°ximo 5MB</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="avatar_url">O usar URL del Avatar</label>
                            <input type="url" id="avatar_url" name="avatar_url" 
                                   value="{{ user.avatar_url or '' }}" 
                                   placeholder="https://ejemplo.com/mi-avatar.jpg">
                            <small class="form-help">Introduce la URL de tu imagen de perfil</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="full_name">Nombre Completo</label>
                        <input type="text" id="full_name" name="full_name" 
                               value="{{ user.full_name or '' }}" 
                               placeholder="Tu nombre completo">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" 
                               value="{{ user.email or '' }}" 
                               placeholder="tu@email.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="bio">Biograf√≠a</label>
                    <textarea id="bio" name="bio" rows="4" 
                              placeholder="Cu√©ntanos algo sobre ti...">{{ user.bio or '' }}</textarea>
                    <small class="form-help">M√°ximo 500 caracteres</small>
                </div>
                
                <div class="form-group">
                    <label for="location">Ubicaci√≥n</label>
                    <input type="text" id="location" name="location" 
                           value="{{ user.location or '' }}" 
                           placeholder="Ciudad, Pa√≠s">
                </div>
            </div>

            <!-- Configuraciones de Privacidad -->
            <div class="form-section">
                <h2 class="section-title">üîê Configuraciones de Privacidad</h2>
                
                <div class="toggle-group">
                    <div class="toggle-item">
                        <div class="toggle-info">
                            <label for="is_public">Perfil P√∫blico</label>
                            <small>Permite que otros usuarios vean tu perfil</small>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="is_public" name="is_public" 
                                   {% if user.is_public %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-item">
                        <div class="toggle-info">
                            <label for="show_stats">Mostrar Estad√≠sticas</label>
                            <small>Permite que otros vean tus estad√≠sticas de pel√≠culas</small>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="show_stats" name="show_stats" 
                                   {% if user.show_stats %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-item">
                        <div class="toggle-info">
                            <label for="email_notifications">Notificaciones por Email</label>
                            <small>Recibe notificaciones de amigos y actividad</small>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="email_notifications" name="email_notifications" 
                                   {% if user.email_notifications %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n de Cuenta -->
            <div class="form-section">
                <h2 class="section-title">üîë Informaci√≥n de Cuenta</h2>
                
                <div class="readonly-info">
                    <div class="info-item">
                        <label>Nombre de Usuario</label>
                        <span class="readonly-value">{{ user.username }}</span>
                    </div>
                    
                    <div class="info-item">
                        <label>Miembro desde</label>
                        <span class="readonly-value">{{ user.created_at.strftime('%d de %B de %Y') }}</span>
                    </div>
                    
                    <div class="info-item">
                        <label>ID de Usuario</label>
                        <span class="readonly-value">#{{ user.id }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                üíæ Guardar Cambios
            </button>
            <a href="{{ url_for('profile') }}" class="btn btn-secondary">
                ‚ùå Cancelar
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Preview del avatar
document.getElementById('avatar_url').addEventListener('input', function() {
    const url = this.value;
    const preview = document.querySelector('.avatar-preview');
    const placeholder = document.querySelector('.avatar-placeholder');
    
    if (url) {
        // Crear nueva imagen para probar si carga
        const img = new Image();
        img.onload = function() {
            if (preview) {
                preview.src = url;
            } else if (placeholder) {
                const newImg = document.createElement('img');
                newImg.src = url;
                newImg.className = 'avatar-preview';
                placeholder.parentNode.replaceChild(newImg, placeholder);
            }
        };
        img.onerror = function() {
            // Si falla, volver al placeholder
            if (preview) {
                const newPlaceholder = document.createElement('div');
                newPlaceholder.className = 'avatar-placeholder';
                newPlaceholder.innerHTML = '<span class="avatar-initials">{{ user.username[0].upper() }}</span>';
                preview.parentNode.replaceChild(newPlaceholder, preview);
            }
        };
        img.src = url;
    }
});

// Contador de caracteres para la bio
document.getElementById('bio').addEventListener('input', function() {
    const maxLength = 500;
    const current = this.value.length;
    const remaining = maxLength - current;
    
    let help = this.parentElement.querySelector('.form-help');
    if (!help) {
        help = document.createElement('small');
        help.className = 'form-help';
        this.parentElement.appendChild(help);
    }
    
    help.textContent = `${remaining} caracteres restantes`;
    help.style.color = remaining < 50 ? '#ff6b6b' : '#6c757d';
    
    if (current > maxLength) {
        this.value = this.value.substring(0, maxLength);
    }
});

// Env√≠o del formulario
document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    // Recopilar datos del formulario
    formData.forEach((value, key) => {
        if (key === 'is_public' || key === 'show_stats' || key === 'email_notifications') {
            data[key] = document.getElementById(key).checked;
        } else {
            data[key] = value;
        }
    });
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.textContent = 'üíæ Guardando...';
        submitBtn.disabled = true;
        
        // Verificar si hay un archivo para subir
        const fileInput = document.getElementById('avatar_file');
        let uploadedImageUrl = null;
        
        if (fileInput.files[0]) {
            // Subir archivo primero
            const formData = new FormData();
            formData.append('avatar_file', fileInput.files[0]);
            
            try {
                const uploadResponse = await fetch('/perfil/upload-avatar', {
                    method: 'POST',
                    body: formData
                });
                
                if (uploadResponse.ok) {
                    const uploadResult = await uploadResponse.json();
                    uploadedImageUrl = uploadResult.url;
                    data.avatar_url = uploadedImageUrl; // Usar la URL del archivo subido
                } else {
                    throw new Error('Error al subir la imagen');
                }
            } catch (uploadError) {
                await showAlert('Error', 'Error al subir la imagen', 'error');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
        }
        
        const response = await fetch('/perfil/editar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            await showAlert('‚úÖ ¬°Guardado!', 'Perfil actualizado exitosamente', 'success');
            window.location.href = '/perfil';
        } else {
            await showAlert('Error', result.error || 'Error al actualizar el perfil', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        await showAlert('Error', 'Error de conexi√≥n al actualizar el perfil', 'error');
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// Manejar vista previa de avatar
document.getElementById('avatar_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const fileName = document.getElementById('fileName');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    
    if (file) {
        // Validar tipo de archivo
        if (!file.type.startsWith('image/')) {
            showAlert('Error', 'Por favor selecciona un archivo de imagen v√°lido', 'error');
            e.target.value = '';
            return;
        }
        
        // Validar tama√±o (5MB)
        if (file.size > 5 * 1024 * 1024) {
            showAlert('Error', 'La imagen es demasiado grande. M√°ximo 5MB', 'error');
            e.target.value = '';
            return;
        }
        
        fileName.textContent = file.name;
        fileName.classList.add('has-file');
        
        // Crear vista previa
        const reader = new FileReader();
        reader.onload = function(e) {
            if (avatarPreview) {
                avatarPreview.src = e.target.result;
            } else {
                // Crear nuevo elemento img si no existe
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Avatar';
                img.className = 'avatar-preview';
                img.id = 'avatarPreview';
                
                // Reemplazar placeholder con imagen
                if (avatarPlaceholder) {
                    avatarPlaceholder.parentNode.replaceChild(img, avatarPlaceholder);
                }
            }
        };
        reader.readAsDataURL(file);
    } else {
        fileName.textContent = 'Ning√∫n archivo seleccionado';
        fileName.classList.remove('has-file');
    }
});

// Limpiar vista previa cuando se cambia URL
document.getElementById('avatar_url').addEventListener('input', function(e) {
    const fileInput = document.getElementById('avatar_file');
    if (e.target.value && fileInput.value) {
        if (confirm('¬øQuieres usar la URL en lugar del archivo seleccionado?')) {
            fileInput.value = '';
            document.getElementById('fileName').textContent = 'Ning√∫n archivo seleccionado';
            document.getElementById('fileName').classList.remove('has-file');
        }
    }
});
</script>
{% endblock %}
