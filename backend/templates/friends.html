{% extends "base.html" %}

{% block title %}Mis Amigos - YTS Downloader{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/friends.css') }}">
{% endblock %}

{% block content %}
<div class="friends-container">
    <h1 class="page-title">ğŸ‘¥ Mis Amigos</h1>
    
    <!-- Buscar usuarios -->
    <div class="friends-section">
        <h2 class="section-title">ğŸ” Buscar Usuarios</h2>
        <div class="search-section">
            <div class="search-users">
                <input type="text" id="searchInput" placeholder="ğŸ” Buscar usuarios por nombre...">
                <button type="button" onclick="searchUsers()" class="btn btn-primary">
                    <span id="searchIcon">ğŸ”</span> Buscar
                </button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>
    </div>
    
    <!-- Solicitudes pendientes -->
    {% if pending_requests %}
    <div class="friends-section">
        <h2 class="section-title">ğŸ“¬ Solicitudes Pendientes</h2>
        <div class="friends-grid">
            {% for request in pending_requests %}
            <div class="user-item" id="request-{{ request.id }}">
                <div class="user-info">
                    <div class="user-avatar">{{ request.username[0].upper() }}</div>
                    <div class="user-details">
                        <h4>{{ request.username }}</h4>
                        <p>Solicitud enviada: {{ request.requested_at.strftime('%d/%m/%Y') }}</p>
                    </div>
                </div>
                <div class="friend-actions">
                    <button class="btn-friend btn-add" onclick="respondRequest({{ request.id }}, 'accept')">
                        âœ… Aceptar
                    </button>
                    <button class="btn-friend btn-remove" onclick="respondRequest({{ request.id }}, 'reject')">
                        âŒ Rechazar
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Lista de amigos -->
    <div class="friends-section">
        <h2 class="section-title">ğŸ‘« Mis Amigos ({{ friends|length }})</h2>
        {% if friends %}
        <div class="friends-grid">
            {% for friend in friends %}
            <div class="user-item">
                <div class="user-info">
                    <div class="user-avatar">{{ friend.username[0].upper() }}</div>
                    <div class="user-details">
                        <h4>{{ friend.username }}</h4>
                        <p>Amigos desde: {{ friend.friendship_since.strftime('%d/%m/%Y') }}</p>
                    </div>
                </div>
                <div class="friend-actions">
                    <a href="/amigo/{{ friend.id }}/listas" class="btn-friend btn-view">
                        ğŸ“‹ Listas
                    </a>
                    <a href="/amigo/{{ friend.id }}/descargas" class="btn-friend btn-view">
                        â¬‡ï¸ Descargas
                    </a>
                    <button class="btn-friend btn-remove" onclick="removeFriend({{ friend.id }})">
                        ğŸ—‘ï¸ Eliminar
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h3>ğŸ¤ Â¡AÃºn no tienes amigos!</h3>
            <p>Busca usuarios arriba para agregar amigos y compartir tus listas de pelÃ­culas.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
<script>
let searchTimeout;

function searchUsers() {
    const query = document.getElementById('searchInput').value.trim();
    const searchIcon = document.getElementById('searchIcon');
    const resultsContainer = document.getElementById('searchResults');
    
    if (!query) {
        resultsContainer.innerHTML = '';
        return;
    }
    
    // Mostrar loading
    searchIcon.innerHTML = '<div class="loading-spinner"></div>';
    resultsContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: #999;">ğŸ” Buscando usuarios...</div>';
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/buscar-usuarios?q=${encodeURIComponent(query)}`);
            const users = await response.json();
            searchIcon.innerHTML = 'ğŸ”';
            displaySearchResults(users);
        } catch (error) {
            console.error('Error buscando usuarios:', error);
            searchIcon.innerHTML = 'âŒ';
            resultsContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--friends-danger);">âŒ Error en la bÃºsqueda</div>';
        }
    }, 300);
}

function displaySearchResults(users) {
    const resultsContainer = document.getElementById('searchResults');
    
    if (users.length === 0) {
        resultsContainer.innerHTML = `
            <div class="empty-state" style="margin: 1rem 0; padding: 2rem;">
                <h4>ğŸ‘¤ No se encontraron usuarios</h4>
                <p>Intenta con otro nombre de usuario</p>
            </div>
        `;
        return;
    }
    
    resultsContainer.innerHTML = users.map(user => `
        <div class="user-item">
            <div class="user-info">
                <div class="user-avatar">${user.username[0].toUpperCase()}</div>
                <div class="user-details">
                    <h4>${user.username}</h4>
                    <p>${getStatusText(user.status)}</p>
                </div>
            </div>
            <div class="friend-actions">
                ${getActionButton(user)}
            </div>
        </div>
    `).join('');
}

function getStatusText(status) {
    switch(status) {
        case 'friends': return 'âœ… Ya son amigos';
        case 'sent': return 'â³ Solicitud enviada';
        case 'received': return 'ğŸ“¬ Te enviÃ³ solicitud';
        case 'blocked': return 'ğŸš« Bloqueado';
        default: return 'ğŸ†• Disponible para agregar';
    }
}

function getActionButton(user) {
    switch(user.status) {
        case 'friends':
            return '<span class="btn-friend btn-pending">âœ… Amigos</span>';
        case 'sent':
            return '<span class="btn-friend btn-pending">â³ Solicitud Enviada</span>';
        case 'received':
            return '<span class="btn-friend btn-pending">ğŸ“¬ Revisa tus Solicitudes</span>';
        case 'blocked':
            return '<span class="btn-friend btn-remove">ğŸš« No Disponible</span>';
        default:
            return `<button class="btn-friend btn-add" onclick="sendFriendRequest(${user.id})">â• Agregar Amigo</button>`;
    }
}

async function sendFriendRequest(userId) {
    try {
        const response = await fetch('/solicitud-amistad', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            await showAlert('Â¡Perfecto!', 'Solicitud de amistad enviada exitosamente', 'success');
            searchUsers(); // Refresh results
        } else {
            await showAlert('Error', result.error || 'Error al enviar solicitud', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        await showAlert('Error', 'Error de conexiÃ³n al enviar solicitud', 'error');
    }
}

async function respondRequest(requestId, action) {
    try {
        const response = await fetch(`/responder-amistad/${requestId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            const actionText = action === 'accept' ? 'aceptada' : 'rechazada';
            await showAlert('Â¡Listo!', `Solicitud ${actionText} correctamente`, 'success');
            document.getElementById(`request-${requestId}`).remove();
            
            if (action === 'accept') {
                location.reload(); // Reload to show new friend
            }
        } else {
            await showAlert('Error', result.error || 'Error al responder solicitud', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        await showAlert('Error', 'Error de conexiÃ³n al responder solicitud', 'error');
    }
}

async function removeFriend(friendId) {
    const confirmed = await showConfirm(
        'Â¿Eliminar amistad?', 
        'Â¿EstÃ¡s seguro de que quieres eliminar esta amistad? Esta acciÃ³n no se puede deshacer.',
        { 
            confirmText: 'SÃ­, eliminar', 
            cancelText: 'Cancelar',
            dangerous: true 
        }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/eliminar-amigo/${friendId}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            await showAlert('Eliminado', 'Amistad eliminada exitosamente', 'success');
            location.reload();
        } else {
            await showAlert('Error', result.error || 'Error al eliminar amistad', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        await showAlert('Error', 'Error de conexiÃ³n al eliminar amistad', 'error');
    }
}

// Auto-search while typing
document.getElementById('searchInput').addEventListener('input', searchUsers);
</script>
{% endblock %}
