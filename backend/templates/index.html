{% extends "base.html" %}

{% block title %}Mis Pel√≠culas - YTS Downloader{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Mis Pel√≠culas</h1>
    <div class="page-actions">
        <button id="checkStatusBtn" class="status-btn">
            üîÑ Actualizar Estados
        </button>
        <button id="refreshPlexBtn" class="status-btn plex-btn">
            üì∫ Actualizar Plex
        </button>
        <div class="status-indicators">
            <span id="transmissionStatus" class="transmission-status">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Verificando conexi√≥n...</span>
            </span>
            <span id="plexStatus" class="transmission-status">
                <span class="status-indicator" id="plexIndicator"></span>
                <span id="plexText">Verificando Plex...</span>
            </span>
        </div>
    </div>
</div>

<div class="movies-grid">
    {% for movie in movies %}
    <div class="movie-card">
        <div class="movie-info">
            <h3 class="movie-title">{{ movie.movie_title }}</h3>
            <div class="movie-details">
                {% if movie.year %}
                <span>üìÖ {{ movie.year }}</span>
                {% endif %}
                {% if movie.rating %}
                <span>‚≠ê {{ movie.rating }}/10</span>
                {% endif %}
                {% if movie.imdb_code %}
                <a href="https://www.imdb.com/title/{{ movie.imdb_code }}" target="_blank" class="imdb-link">
                    üé¨ IMDB
                </a>
                {% endif %}
            </div>
            <div class="movie-meta">
                <span class="date-info">üìÖ {{ movie.download_date.strftime('%d/%m/%Y') }}</span>
                <span class="status-badge {{ movie.status }}">{{ movie.status }}</span>
            </div>
            <div class="movie-actions">
                {% if movie.status == 'pendiente' %}
                <button class="action-btn download-btn" onclick="startDownload({{ movie.id }})">
                    ‚ñ∂Ô∏è Iniciar Descarga
                </button>
                {% endif %}
                <div class="movie-links">
                    <a href="{{ movie.magnet }}" class="link-btn magnet-btn" title="Magnet Link">
                        üß≤ Magnet
                    </a>
                    <button class="action-btn delete-btn" onclick="deleteMovie({{ movie.id }})">
                        üóëÔ∏è Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <p class="no-results">No hay pel√≠culas en tu lista</p>
        <a href="/search" class="empty-action-btn">üîç Buscar Pel√≠culas</a>
    </div>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkStatusBtn = document.getElementById('checkStatusBtn');
    const refreshPlexBtn = document.getElementById('refreshPlexBtn');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const plexIndicator = document.getElementById('plexIndicator');
    const plexText = document.getElementById('plexText');
    
    // Verificar estado de conexi√≥n al cargar
    checkTransmissionConnection();
    checkPlexConnection();
    
    // Bot√≥n para actualizar estados
    checkStatusBtn.addEventListener('click', function() {
        checkStatusBtn.disabled = true;
        checkStatusBtn.innerHTML = 'üîÑ Actualizando...';
        
        fetch('/api/check-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(async data => {
            if (data.message) {
                await showAlert('¬°Excelente!', 'Estados actualizados correctamente', 'success');
                location.reload(); // Recargar para mostrar cambios
            } else {
                await showAlert('Error', 'Error al actualizar estados: ' + (data.error || 'Error desconocido'), 'error');
            }
        })
        .catch(async error => {
            console.error('Error:', error);
            await showAlert('Error', 'Error al actualizar estados', 'error');
        })
        .finally(() => {
            checkStatusBtn.disabled = false;
            checkStatusBtn.innerHTML = 'üîÑ Actualizar Estados';
        });
    });
    
    // Bot√≥n para actualizar Plex
    refreshPlexBtn.addEventListener('click', function() {
        refreshPlexBtn.disabled = true;
        refreshPlexBtn.innerHTML = 'üì∫ Actualizando...';
        
        fetch('/api/plex-refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(async data => {
            if (data.message) {
                await showAlert('üì∫ ¬°Perfecto!', 'Biblioteca de Plex actualizada correctamente', 'success');
            } else {
                await showAlert('Error', 'Error al actualizar Plex: ' + (data.error || 'Error desconocido'), 'error');
            }
        })
        .catch(async error => {
            console.error('Error:', error);
            await showAlert('Error', 'Error al actualizar Plex', 'error');
        })
        .finally(() => {
            refreshPlexBtn.disabled = false;
            refreshPlexBtn.innerHTML = 'üì∫ Actualizar Plex';
        });
    });
    
    function checkTransmissionConnection() {
        fetch('/api/transmission-status')
        .then(response => response.json())
        .then(data => {
            if (data.connected) {
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = `Transmission ${data.version || 'conectado'}`;
            } else {
                statusIndicator.className = 'status-indicator disconnected';
                statusText.textContent = 'Transmission desconectado';
            }
        })
        .catch(error => {
            statusIndicator.className = 'status-indicator error';
            statusText.textContent = 'Error de conexi√≥n';
        });
    }
    
    function checkPlexConnection() {
        fetch('/api/plex-status')
        .then(response => response.json())
        .then(data => {
            if (data.connected) {
                plexIndicator.className = 'status-indicator connected';
                plexText.textContent = `Plex (${data.movie_sections || 0} secciones)`;
            } else {
                plexIndicator.className = 'status-indicator disconnected';
                plexText.textContent = 'Plex desconectado';
            }
        })
        .catch(error => {
            plexIndicator.className = 'status-indicator error';
            plexText.textContent = 'Error Plex';
        });
    }
});

async function startDownload(movieId) {
    try {
        const response = await fetch(`/download/${movieId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (response.ok) {
            await showAlert('üé¨ ¬°Descarga iniciada!', 'Descarga iniciada correctamente', 'success');
            location.reload();
        } else {
            await showAlert('Error', data.error || 'Error al iniciar la descarga', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        await showAlert('Error', 'Error al comunicarse con el servidor', 'error');
    }
}

async function deleteMovie(movieId) {
    const confirmed = await showConfirm(
        '¬øEliminar pel√≠cula?', 
        '¬øEst√°s seguro de que quieres eliminar esta pel√≠cula de tu lista?',
        { confirmText: 'S√≠, eliminar', cancelText: 'Cancelar', dangerous: true }
    );
    
    if (confirmed) {
        try {
            const response = await fetch(`/delete/${movieId}`, {
                method: 'POST'
            });
            const data = await response.json();
            
            if (response.ok) {
                await showAlert('üóëÔ∏è Eliminada', 'Pel√≠cula eliminada correctamente', 'success');
                location.reload();
            } else {
                await showAlert('Error', data.error || 'Error al eliminar la pel√≠cula', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            await showAlert('Error', 'Error al comunicarse con el servidor', 'error');
        }
    }
}
</script>
{% endblock %}
