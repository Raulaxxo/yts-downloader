{% extends "base.html" %}

{% block title %}Buscar Pel√≠culas - YTS Downloader{% endblock %}

{% block content %}
<h1 class="page-title">Buscar Pel√≠culas</h1>
        
<form method="GET" class="search-form">
    <input type="text" 
           name="query" 
           placeholder="Buscar pel√≠cula..." 
           value="{{ query }}" 
           autocomplete="off"
           required>
    <button type="submit">Buscar</button>
</form>

{% if results %}
    {% if total_results > 0 %}
        <div class="search-info">
            <p>Se encontraron {{ total_results }} pel√≠culas{% if query %} para "{{ query }}"{% endif %}</p>
        </div>
    {% endif %}

    <div class="search-results">
        {% for movie in results %}
        <div class="movie-card">
            <img src="{{ movie.medium_cover_image }}" 
                 alt="{{ movie.title }}" 
                 class="movie-poster"
                 loading="lazy">
            <div class="movie-info">
                <h3>{{ movie.title_long }}</h3>
                <div class="movie-details">
                    <span>üìÖ {{ movie.year }}</span>
                    <span>‚≠ê {{ movie.rating }}/10</span>
                    {% if movie.language %}
                    <span>üó£ {{ movie.language }}</span>
                    {% endif %}
                </div>
                <div class="movie-actions">
                    <button class="add-movie" 
                            title="Agregar pel√≠cula a la lista"
                            onclick="addMovie({
                            title: '{{ movie.title_long }}',
                            year: '{{ movie.year }}',
                            rating: '{{ movie.rating }}',
                            magnet: '{{ build_magnet(movie)|safe }}',
                            subs: 'https://yifysubtitles.org/movie-imdb/{{ movie.imdb_code }}',
                            imdb_code: '{{ movie.imdb_code }}'
                        })">
                    Agregar
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
    </div>

    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
            <a href="{{ url_for('search', query=query, page=page-1) }}" class="page-link">‚Üê Anterior</a>
        {% endif %}
        
        <div class="page-numbers">
            {% if page > 2 %}
                <a href="{{ url_for('search', query=query, page=1) }}" class="page-link">1</a>
                {% if page > 3 %}
                    <span class="page-ellipsis">...</span>
                {% endif %}
            {% endif %}

            {% if page > 1 %}
                <a href="{{ url_for('search', query=query, page=page-1) }}" class="page-link">{{ page - 1 }}</a>
            {% endif %}

            <span class="page-link current">{{ page }}</span>

            {% if page < total_pages %}
                <a href="{{ url_for('search', query=query, page=page+1) }}" class="page-link">{{ page + 1 }}</a>
            {% endif %}

            {% if page < total_pages - 1 %}
                {% if page < total_pages - 2 %}
                    <span class="page-ellipsis">...</span>
                {% endif %}
                <a href="{{ url_for('search', query=query, page=total_pages) }}" class="page-link">{{ total_pages }}</a>
            {% endif %}
        </div>

        {% if page < total_pages %}
            <a href="{{ url_for('search', query=query, page=page+1) }}" class="page-link">Siguiente ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
{% elif query %}
<div class="empty-state">
    <p class="no-results">No se encontraron resultados para "{{ query }}"</p>
    <p class="suggestion">Intenta con otro t√©rmino de b√∫squeda</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function addMovie(movieData) {
    try {
        const response = await fetch('/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(movieData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            window.location.href = '/'; // Redirigir a la lista de pel√≠culas
        } else {
            alert(result.error || 'Error al agregar la pel√≠cula');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al comunicarse con el servidor');
    }
}
</script>
{% endblock %}
